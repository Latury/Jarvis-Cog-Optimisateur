<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="dark light" />

  <link rel="icon" type="image/x-icon" href="favicon.ico" />

  <link rel="stylesheet" href="style.css" />
  <script type="text/javascript" src="Optimiseur.js"></script>
  <script type="text/javascript" src="Resolveur.js"></script>
  <script type="text/javascript" src="InventaireEngrenages.js"></script>
  <script type="text/javascript" src="AfficheurPlateau.js"></script>
  <script type="text/javascript" src="AfficheurJoueur.js"></script>
  <script type="text/javascript" src="GestionPages.js"></script>

  <title>Jarvis Cog Optimisateur</title>

  <style>
    /* Styles pour la console de logs */
    #logConsole {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #1a1a2e;
      border-top: 3px solid #ff6b6b;
      max-height: 250px;
      overflow-y: auto;
      z-index: 9999;
      padding: 15px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      box-shadow: 0 -4px 6px rgba(0, 0, 0, 0.3);
    }

    #toggleLogs {
      position: fixed;
      bottom: 10px;
      right: 10px;
      background: #ff6b6b;
      color: white;
      border: none;
      padding: 10px 15px;
      cursor: pointer;
      border-radius: 5px;
      z-index: 10000;
      font-weight: bold;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    #toggleLogs:hover {
      background: #ee5a5a;
    }

    .log-line {
      margin: 3px 0;
      padding: 5px;
      border-left: 3px solid #555;
      padding-left: 10px;
    }

    .log-error {
      color: #e74c3c;
      background: #3d0a0a;
      border-left-color: #e74c3c;
    }

    .log-warn {
      color: #f39c12;
      border-left-color: #f39c12;
    }

    .log-success {
      color: #2ecc71;
      border-left-color: #2ecc71;
    }

    .log-info {
      color: #3498db;
      border-left-color: #3498db;
    }
  </style>

</head>

<body>
  <div class="menucontainer">
    <ul class="menu">
      <li id="loaderbtn" class="active">
        <div>
          <div>
            <div>Chargeur</div>
          </div>
        </div>
      </li>
      <li id="cogbtn">
        <div>
          <div>
            <div>Engrenages</div>
          </div>
        </div>
      </li>
    </ul>
    <div class="options">
      <button id="settingsbtn">
        <div></div>
        <div>
          Paramètres
          <div class="checkbox"></div>
        </div>
        <div></div>
      </button>
      <button id="solve">
        <div></div>
        <div id="solvetext">Optimiser</div>
        <div></div>
      </button>
    </div>
    <div class="spacer"></div>
  </div>
  <div class="content">
    <!-- Popup de tutoriel -->
    <div id="tutorialPopup" style="
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(135deg, #1a2332 0%, #2d3e50 100%);
        padding: 40px;
        border-radius: 15px;
        border: 3px solid #3498db;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        z-index: 10000;
        max-width: 600px;
        text-align: center;
      ">
      <h2 style="color: #3498db; margin: 0 0 20px 0; font-size: 28px;">
        🎮 Bienvenue sur Jarvis Cog Optimisateur !
      </h2>

      <div style="color: #ecf0f1; font-size: 16px; line-height: 1.8; text-align: left; margin-bottom: 30px;">
        <p style="margin: 15px 0;"><strong style="color: #2ecc71;">📌 Étape 1 :</strong> Copiez les données sur <a
            href="https://idleontoolbox.com/data" target="_blank" style="color: #3498db;">IdleonToolbox.com/data</a></p>
        <p style="margin: 15px 0;"><strong style="color: #2ecc71;">📌 Étape 2 :</strong> Collez-les dans la zone de
          texte ci-dessous</p>
        <p style="margin: 15px 0;"><strong style="color: #2ecc71;">📌 Étape 3 :</strong> Cliquez sur "Charger" pour
          importer vos engrenages</p>
        <p style="margin: 15px 0;"><strong style="color: #2ecc71;">📌 Étape 4 :</strong> Cliquez sur "Optimiser" pour
          obtenir la meilleure configuration</p>
      </div>

      <button onclick="closeTutorial()" style="
          background: #2ecc71;
          color: white;
          border: none;
          padding: 15px 40px;
          font-size: 18px;
          font-weight: bold;
          border-radius: 8px;
          cursor: pointer;
          box-shadow: 0 4px 10px rgba(46, 204, 113, 0.4);
        ">
        J'ai compris ! 🚀
      </button>
    </div>

    <!-- Fond sombre derrière la popup -->
    <div id="tutorialOverlay" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 9999;
      "></div>

    <div id="loader">
      <div class="inputarea">
        <textarea type="textarea" id="input" rows="10" cols="100"></textarea>
        <div>
          <button id="load" style="max-width: 15ch;">Charger</button>
        </div>
      </div>
    </div>

    <div id="result">
      <!-- COLONNE GAUCHE : Inventaire + Stats actuelles -->
      <div id="leftColumn" class="column">
        <div class="info">
          <div id="spare">---Placeholder---</div>
          <div id="sparepage"></div>
        </div>

        <!-- Stats actuelles (affichées après chargement) -->
        <div id="currentStats" style="display: none;"></div>
      </div>

      <!-- COLONNE CENTRE : Grille + Head -->
      <div id="centerColumn" class="column">
        <div id="currentBoard"></div>
      </div>

      <!-- COLONNE DROITE : Stats comparatives + Étapes -->
      <div id="rightColumn" class="column">
        <!-- Tableau récapitulatif compact -->
        <div id="summaryStats" style="display: none;"></div>

        <!-- Stats détaillées avant/après -->
        <div id="detailedStats" style="display: none;"></div>

        <!-- Étapes de déplacement -->
        <div id="steps"></div>
      </div>

      <!-- Settings (popup paramètres) -->
      <div id="settings" style="display: none;">
        <p>
          <label for="flaggyShop">Améliorations Flaggy (Boutique gemmes)</label><br />
          <input type="number" id="flaggyShop" value="0" style="width:6ch" disabled=true></input>
        </p>
        <p>
          <label for="buildRate">Poids vitesse de construction</label><br />
          <input type="number" id="buildRate" value="2" style="width:6ch"></input>
        </p>
        <p>
          <label for="expBonus">Poids bonus EXP</label><br />
          <input type="number" id="expBonus" value="50" style="width:6ch"></input>
        </p>
        <p>
          <label for="flaggy">Poids taux Flaggy</label><br />
          <input type="number" id="flaggy" value="5" style="width:6ch"></input>
        </p>
        <p>
          <label for="solveTime">Temps d'optimisation (ms)</label><br />
          <input type="number" id="solveTime" value="2500" style="width:10ch"></input>
        </p>
        <h4>Divers</h4>
        <hr />
        <p>
          <label for="showStats">Afficher les stats des engrenages ?</label>
          <input type="checkbox" id="showStats" />
        </p>
        <p>
          <label for="showSolved">Afficher directement la grille optimisée</label>
          <input type="checkbox" id="showSolved" />
        </p>
      </div>
    </div>

    <!-- Console de logs pour debug -->
    <div id="logConsole">
      <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
        <span style="color: #ff6b6b; font-weight: bold;">📋 Console de Debug</span>
        <div>
          <button onclick="copyLogs()"
            style="background: #3498db; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 3px; margin-right: 5px;">📋
            Copier</button>
          <button onclick="clearLogs()"
            style="background: #e74c3c; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 3px;">Effacer</button>
        </div>
      </div>
      <div id="logContent"></div>
    </div>
  </div>

  <!-- Bouton pour afficher/masquer les logs -->
  <button id="toggleLogs">📋 Logs</button>
  <script type="text/javascript">
    // ========================================
    // SYSTÈME DE LOGS POUR DEBUG
    // ========================================

    const originalConsoleLog = console.log;
    const originalConsoleError = console.error;
    const originalConsoleWarn = console.warn;

    function addLog(message, type = 'info') {
      const logContent = document.getElementById('logContent');
      if (!logContent) return;

      const logLine = document.createElement('div');
      logLine.className = `log-line log-${type}`;

      const timestamp = new Date().toLocaleTimeString();

      switch (type) {
        case 'error':
          logLine.textContent = `❌ [${timestamp}] ${message}`;
          break;
        case 'warn':
          logLine.textContent = `⚠️ [${timestamp}] ${message}`;
          break;
        case 'success':
          logLine.textContent = `✅ [${timestamp}] ${message}`;
          break;
        default:
          logLine.textContent = `ℹ️ [${timestamp}] ${message}`;
      }

      logContent.appendChild(logLine);
      logContent.scrollTop = logContent.scrollHeight;

      if (type === 'error') {
        originalConsoleError(message);
      } else if (type === 'warn') {
        originalConsoleWarn(message);
      } else {
        originalConsoleLog(message);
      }
    }

    console.log = function (...args) {
      addLog(args.join(' '), 'info');
    };

    console.error = function (...args) {
      addLog(args.join(' '), 'error');
    };

    console.warn = function (...args) {
      addLog(args.join(' '), 'warn');
    };

    window.addEventListener('error', (event) => {
      addLog(`ERREUR GLOBALE: ${event.message} (${event.filename}:${event.lineno})`, 'error');
    });

    document.getElementById('toggleLogs').addEventListener('click', () => {
      const logConsole = document.getElementById('logConsole');
      if (logConsole.style.display === 'none' || logConsole.style.display === '') {
        logConsole.style.display = 'block';
      } else {
        logConsole.style.display = 'none';
      }
    });

    function clearLogs() {
      document.getElementById('logContent').innerHTML = '';
      addLog('Logs effacés', 'info');
    }

    function copyLogs() {
      const logContent = document.getElementById('logContent');
      const texte = logContent.innerText;

      navigator.clipboard.writeText(texte).then(() => {
        addLog('✅ Logs copiés dans le presse-papiers !', 'success');

        setTimeout(() => {
          const logs = logContent.querySelectorAll('.log-line');
          const dernierLog = logs[logs.length - 1];
          if (dernierLog && dernierLog.textContent.includes('Logs copiés')) {
            dernierLog.style.opacity = '0.5';
          }
        }, 2000);
      }).catch((err) => {
        addLog('❌ Erreur lors de la copie : ' + err, 'error');
      });
    }

    function closeTutorial() {
      document.getElementById("tutorialPopup").style.display = "none";
      document.getElementById("tutorialOverlay").style.display = "none";
    }

    addLog('🚀 Interface chargée - Système de logs activé', 'success');

    document.getElementById("cogbtn").style.pointerEvents = "none";
    document.getElementById("cogbtn").style.opacity = "0.5";
    document.getElementById("settingsbtn").disabled = true;
    document.getElementById("settingsbtn").style.opacity = "0.5";
    document.getElementById("solve").disabled = true;
    document.getElementById("solve").style.opacity = "0.5";

    // ========================================
    // CODE PRINCIPAL
    // ========================================

    function createSwitchAnimation() {
      let fromDiv, timerID;

      fromDiv = document.createElement("div");
      document.body.appendChild(fromDiv);

      return function animateSwitch(fromElem, targetBoundingRect) {
        fromDiv.className = "";

        Object.values(fromElem.style)
          .filter((v) => !(v in ["height", "width", "position"]))
          .forEach((key) => {
            let value = fromElem.style[key];
            fromDiv.style[key] = value;
          });

        const bounds = fromElem.getBoundingClientRect();
        fromDiv.style.width = bounds.width + "px";
        fromDiv.style.height = bounds.height + "px";
        fromDiv.style.top = bounds.top + "px";
        fromDiv.style.left = bounds.left + "px";

        clearTimeout(timerID);
        timerID = setTimeout(() => {
          fromDiv.className = "switch";

          const bounds = targetBoundingRect;
          fromDiv.style.width = bounds.width + "px";
          fromDiv.style.height = bounds.height + "px";
          fromDiv.style.top = bounds.top + "px";
          fromDiv.style.left = bounds.left + "px";
        }, 10);
      }
    }

    const animateSwitchFrom = createSwitchAnimation();
    const animateSwitchTo = createSwitchAnimation();

    const player = new AfficheurJoueur();
    window.player = player;

    const ROWS = 8;
    const COLUMNS = 12;
    const OPTIMIZABLE = ["buildRate", "expBonus", "flaggy"];

    const getInput = (id) => Number.parseInt(document.getElementById(id).value);
    const getFlaggyShop = getInput.bind(null, "flaggyShop");

    const createElem = function createElem(tagName, style = undefined) {
      const elem = document.createElement(tagName);
      if (style) {
        elem.style = style;
      }
      return elem;
    }

    window.g = {
      cogs: {},
      board: [],
      best: null
    };
    window.f = {};

    window.boardRenderer = new AfficheurPlateau(ROWS, COLUMNS, "board");
    window.spareRenderer = new AfficheurPlateau(40, 3, "spare", 5);
    window.solver = new Resolveur();
    window.cogInventory = new InventaireEngrenages();

    window.sparePage = new GestionPages("sparepage", window.spareRenderer._pageCount, 1);
    window.sparePage.addEventListener("change", (ev) => {
      window.spareRenderer.showPage(ev.page);
    });

    const boardElem = document.getElementById("currentBoard");
    boardElem.innerHTML = "";
    boardElem.appendChild(window.boardRenderer.createHTMLElement());

    const stepContainer = createElem("div");
    stepContainer.id = "stepspage";
    boardElem.appendChild(stepContainer);
    const stepsPage = new GestionPages("stepspage", 0, 0, "Étape");
    stepsPage.addEventListener("change", stepsChangeHandler);

    window.addEventListener("keyup", (ev) => {
      if (ev.key == "ArrowLeft") {
        stepsPage.prev(ev);
      } else if (ev.key == "ArrowRight") {
        stepsPage.next(ev);
      }
    }, true);

    const spareElem = document.getElementById("spare");
    const spareParent = spareElem.parentNode;
    spareParent.insertBefore(window.spareRenderer.createHTMLElement(), spareElem);
    spareParent.removeChild(spareElem);

    const settingsBtn = document.getElementById("settingsbtn");
    const slider = settingsBtn.childNodes[3].childNodes[1];
    const settingsPage = document.getElementById("settings");
    const borderElem = document.getElementById("border");
    settingsBtn.addEventListener("click", () => {
      const active = slider.classList.contains("active");
      if (active) {
        slider.classList.remove("active");
        settingsPage.style.display = "none";
      } else {
        openCogTab();

        slider.classList.add("active");
        settingsPage.style.display = "";
        settingsPage.style.left = borderElem.offsetLeft + "px";
        settingsPage.style.height = borderElem.offsetHeight + "px";
      }
    })

    f.verifyBoardIntegrity = (board) => {
      for (let y = 0; y < board.length; y++) {
        for (let x = 0; x < board[y].length; x++) {
          if (board[y][x].blocked) continue;
          const tempPos = board[y][x].position();
          if (tempPos.x !== x || tempPos.y !== y) {
            debugger;
          }
        }
      }
    }

    f.printBoard = (board, cord1 = {}, cord2 = {}) => {
      for (let i = 0; i < board.length; i++) {
        const row = createElem("tr");

        for (let j = 0; j < board[i].length; j++) {
          window.boardRenderer.set(i, j, board[i][j]);
        }
      }

      console.log("Grille mise à jour");
    }

    function yield() {
      return new Promise(r => setTimeout(r, 1));
    }

    f.printMove = (stepNumber, board, cog1, cog2, pos1, pos2, showStats = false) => {
      const toAdd = createElem("p");

      let text = `Échanger ${pos1.location} \
        [${pos1.x + 1}|${pos1.y + 1}]`;
      if (showStats) {
        text += ` (${cog1.buildRate || 0}:${cog1.expBonus || 0}:${cog1.flaggy || 0})`;
      }
      text += ` <span style="background-image: url('${cog1.icon.path}')"></span> avec ${pos2.location} [${pos2.x + 1}|${pos2.y + 1}]`;
      if (showStats) {
        text += ` (${cog2.buildRate || 0}:${cog2.expBonus || 0}:${cog2.flaggy || 0})`;
      }
      text += ` <span style="background-image: url('${cog2.icon.path}')"></span>`;

      toAdd.innerHTML = text;

      toAdd.onclick = () => {
        stepsPage.goto(stepNumber);
      }
      document.getElementById("steps").appendChild(toAdd);
    }
    f.getOptimalSteps = (board, cogs) => {
      const steps = [];

      const cogsToMove = Object.values(cogs)
        .map(c => { return new Engrenage(c) })
        .filter((c) => c.key !== c.initialKey);

      const interimCogs = {};
      for (const cog of cogsToMove) {
        interimCogs[cog.initialKey] = cog;
      }

      let tuple;
      while (tuple = Object.entries(interimCogs)[0]) {
        const [key, cog] = tuple;
        const targetCog = interimCogs[cog.key] || { icon: "Blank", key, position: cog.position.bind(cog) };
        if (targetCog === cog) {
          delete interimCogs[key];
          continue;
        }
        interimCogs[key] = targetCog;
        steps.push({
          board,
          cog,
          targetCog,
          keyFrom: Number.parseInt(key),
          keyTo: Number.parseInt(cog.key)
        });
        delete interimCogs[cog.key];
      }

      return steps;
    }

    f.printOptimalSteps = (steps) => {
      document.getElementById("steps").innerHTML = "";
      const showStats = document.getElementById("showStats").checked;

      for (let i = 0; i < steps.length; i++) {
        const step = steps[i];
        f.printMove(
          i,
          step.board,
          step.cog,
          step.targetCog,
          step.cog.position(step.keyFrom),
          step.targetCog.position(step.keyTo),
          showStats);
      }
    }

    function mmoifyNumber(num, addSign = true) {
      let str = num;

      if (Math.abs(num) >= 1000000) {
        str = (Math.ceil(num / 10000) / 100) + "M";
      } else if (Math.abs(num) >= 1000) {
        str = (Math.ceil(num / 10) / 100) + "K";
      }

      if (addSign && num >= 0) {
        str = "+" + str;
      }

      return str.toString();
    }

    function stepsChangeHandler(ev) {
      if (!window.g.best) return;
      const steps = f.getOptimalSteps(window.g.best.board, window.g.best.cogs);
      if (ev.page < steps.length) {
        const step = steps[ev.page];
        const pos1 = step.cog.position(step.keyFrom);
        const pos2 = step.targetCog.position(step.keyTo);

        window.boardRenderer.get(pos1.y, pos1.x).elem.classList.add("toMove");
        window.boardRenderer.get(pos2.y, pos2.x).elem.classList.add("toMove");
      }
    }

    function load(save) {
      try {
        console.log("🔄 Démarrage du chargement...");

        console.log("📦 Chargement des données de sauvegarde...");

        // Vérifier que les données ne sont pas vides
        if (!save || save.trim() === "" || save === "undefined") {
          throw new Error("Les données sont vides ou invalides. Veuillez coller vos données depuis IdleonToolbox.com/data");
        }

        cogInventory.load(JSON.parse(save));


        document.getElementById("flaggyShop").value = cogInventory.ameliorationsBoutiqueFlaggy;
        console.log("💎 Améliorations Flaggy (boutique):", cogInventory.ameliorationsBoutiqueFlaggy);
        console.log("✅ Flaggy shop mis à jour");

        for (let i = 108; i < 200; i++) {
          const engrenage = cogInventory.engrenages[i];

          if (!engrenage) continue;
          const index = (i - 108);
          const row = Math.floor(index / 3);
          const col = index % 3;
          window.spareRenderer.set(row, col, engrenage);
        }
        console.log("✅ Engrenages spare affichés");

        window.spareRenderer._pageCount = Math.ceil(Object.keys(cogInventory.engrenages).filter(k => parseInt(k) >= 108).length / 3);
        window.sparePage.nombrePages = window.spareRenderer._pageCount;
        window.sparePage.indexPage = 0;
        window.sparePage.goto(0);
        console.log("📄 Nombre de pages spare recalculé:", window.spareRenderer._pageCount);
        console.log("✅ Page spare initialisée");

        const initScore = cogInventory.score;

        f.printBoard(cogInventory.board);
        console.log("✅ Grille affichée");

        document.getElementById("solve").disabled = "";
        console.log("✅ Bouton optimiser activé");

        const currentStats = document.getElementById("currentStats");
        currentStats.style.display = "block";
        currentStats.innerHTML = `
          <h3 style="color: #3498db; font-size: 16px; margin-bottom: 10px;">📊 STATS ACTUELLES</h3>
          <div style="margin: 8px 0;">
            <div style="color: #95a5a6; font-size: 11px;">🏗️ Vitesse construction</div>
            <div style="color: #3498db; font-weight: bold;">${mmoifyNumber(initScore.buildRate, false)}/HR</div>
          </div>
          <div style="margin: 8px 0;">
            <div style="color: #95a5a6; font-size: 11px;">⭐ Bonus XP</div>
            <div style="color: #9b59b6; font-weight: bold;">${mmoifyNumber(initScore.expBonus, false)}%</div>
          </div>
          <div style="margin: 8px 0;">
            <div style="color: #95a5a6; font-size: 11px;">🚩 Taux Flaggy</div>
            <div style="color: #e67e22; font-weight: bold;">${mmoifyNumber(initScore.flaggy, false)}/HR</div>
          </div>
        `;
        console.log("✅ Stats actuelles affichées");

        for (let oneOption of [...OPTIMIZABLE, "solveTime"]) {
          const val = localStorage.getItem(oneOption);
          if (val) {
            document.getElementById(oneOption).value = val;
          }
        }
        console.log("✅ Options chargées");

        openCogTab();
        console.log("✅ Onglet Engrenages ouvert");

        document.getElementById("cogbtn").style.pointerEvents = "auto";
        document.getElementById("cogbtn").style.opacity = "1";
        document.getElementById("settingsbtn").disabled = false;
        document.getElementById("settingsbtn").style.opacity = "1";
        document.getElementById("solve").disabled = false;
        document.getElementById("solve").style.opacity = "1";
        console.log("✅ Tous les boutons activés");

        console.log("🎉 CHARGEMENT TERMINÉ AVEC SUCCÈS !");
      } catch (error) {
        console.error("❌ Erreur lors du chargement:", error);
        alert("Erreur lors du chargement: " + error.message);
      }
    }

    function openCogTab() {
      document.getElementById("loader").style.display = "none";
      document.getElementById("result").style.display = "inherit";

      document.getElementById("loaderbtn").className = "";
      document.getElementById("cogbtn").className = "active";
    }

    function openLoaderTab() {
      document.getElementById("loader").style.display = "inherit";
      document.getElementById("result").style.display = "none";

      document.getElementById("loaderbtn").className = "active";
      document.getElementById("cogbtn").className = "";
    }

    document.getElementById("loaderbtn").addEventListener("click", () => {
      openLoaderTab();
    });

    document.getElementById("cogbtn").addEventListener("click", () => {
      openCogTab();
    });

    document.getElementById("load").addEventListener("click", () => {
      try {
        const input = document.getElementById("input").value;
        console.log("📝 Valeur du textarea:", input ? `${input.length} caractères` : "VIDE !");

        if (!input || input.trim() === "") {
          alert("⚠️ La zone de texte est vide ! Collez d'abord les données depuis IdleonToolbox.com/data");
          return;
        }

        load(input);
        closeTutorial();
      } catch (error) {
        console.error("❌ Erreur:", error);
        alert("Erreur: " + error.message);
      }
    });


    document.getElementById("solve").onclick = async function () {
      console.log("Démarrage");

      document.getElementById("solvetext").innerText = "⏳";

      for (let oneOption of OPTIMIZABLE) {
        localStorage.setItem(oneOption, document.getElementById(oneOption).value);
      }

      const poids = {
        buildRate: parseInt(document.getElementById("buildRate").value),
        expBonus: parseInt(document.getElementById("expBonus").value),
        flaggy: parseInt(document.getElementById("flaggy").value),
      };

      console.log("⚖️ Poids définis :", poids);

      const start = window.cogInventory.copy();
      const startScore = start.score;

      try {
        console.log("🚀 Début de l'optimisation");
        const timeLimit = parseInt(document.getElementById("solveTime").value);
        console.log("⏱️ Temps alloué :", timeLimit + "ms");

        const best = await Optimiser.optimiser(window.cogInventory, poids, timeLimit);

        if (!best || !best.score) {
          throw new Error("Optimisation échouée");
        }

        console.log("✅ Optimisation terminée !");
        console.log("🏆 Meilleur score :", best.score.buildRate);
        console.log("📋 " + (best.etapes ? best.etapes.length : 0) + " déplacements à effectuer");

        console.log("🔄 Conversion de la solution optimisée...");
        const solutionConvertie = Optimiser.convertirSolution(best);
        console.log("✅ Solution convertie avec succès");

        const buildRateGain = best.score.buildRate - startScore.buildRate;
        const expBonusGain = best.score.expBonus - startScore.expBonus;
        const flaggyGain = best.score.flaggy - startScore.flaggy;

        const buildRatePercent = ((buildRateGain / startScore.buildRate) * 100).toFixed(2);
        const expBonusPercent = ((expBonusGain / startScore.expBonus) * 100).toFixed(2);
        const flaggyPercent = ((flaggyGain / startScore.flaggy) * 100).toFixed(2);

        console.log("Affichage de la grille optimisée...");
        f.printBoard(solutionConvertie.board);

        const summaryStats = document.getElementById("summaryStats");
        summaryStats.style.display = "block";
        summaryStats.innerHTML = `
          <h3 style="color: #2ecc71; font-size: 16px; margin: 0 0 10px 0; text-align: center;">✅ OPTIMISATION RÉUSSIE</h3>
          <div style="text-align: center; color: #ecf0f1; font-size: 13px;">
            <div>📈 Score final: ${best.score.buildRate.toFixed(0)}</div>
            <div style="color: #2ecc71; margin-top: 5px;">+${mmoifyNumber(buildRateGain)}/HR (${buildRatePercent > 0 ? '+' : ''}${buildRatePercent}%)</div>
          </div>
        `;

        const detailedStats = document.getElementById("detailedStats");
        detailedStats.style.display = "block";
        detailedStats.innerHTML = `
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div>
              <h4 style="color: #e74c3c; font-size: 14px; margin-bottom: 10px; text-align: center;">📊 AVANT</h4>
              <div style="font-size: 11px; margin: 8px 0;">
                <div style="color: #95a5a6;">🏗️ Construction</div>
                <div style="color: #ecf0f1; font-weight: bold;">${mmoifyNumber(startScore.buildRate, false)}/HR</div>
              </div>
              <div style="font-size: 11px; margin: 8px 0;">
                <div style="color: #95a5a6;">⭐ Bonus XP</div>
                <div style="color: #ecf0f1; font-weight: bold;">${mmoifyNumber(startScore.expBonus, false)}%</div>
              </div>
              <div style="font-size: 11px; margin: 8px 0;">
                <div style="color: #95a5a6;">🚩 Taux Flaggy</div>
                <div style="color: #ecf0f1; font-weight: bold;">${mmoifyNumber(startScore.flaggy, false)}/HR</div>
              </div>
            </div>
            <div>
              <h4 style="color: #2ecc71; font-size: 14px; margin-bottom: 10px; text-align: center;">📈 APRÈS</h4>
              <div style="font-size: 11px; margin: 8px 0;">
                <div style="color: #95a5a6;">🏗️ Construction</div>
                <div style="color: #2ecc71; font-weight: bold;">${mmoifyNumber(best.score.buildRate, false)}/HR</div>
                ${buildRatePercent > 0 ? `<div style="color: #3498db; font-size: 10px;">▲ +${buildRatePercent}%</div>` : ''}
              </div>
              <div style="font-size: 11px; margin: 8px 0;">
                <div style="color: #95a5a6;">⭐ Bonus XP</div>
                <div style="color: #2ecc71; font-weight: bold;">${mmoifyNumber(best.score.expBonus, false)}%</div>
                ${expBonusPercent > 0 ? `<div style="color: #3498db; font-size: 10px;">▲ +${expBonusPercent}%</div>` : ''}
              </div>
              <div style="font-size: 11px; margin: 8px 0;">
                <div style="color: #95a5a6;">🚩 Taux Flaggy</div>
                <div style="color: #2ecc71; font-weight: bold;">${mmoifyNumber(best.score.flaggy, false)}/HR</div>
                ${flaggyPercent > 0 ? `<div style="color: #3498db; font-size: 10px;">▲ +${flaggyPercent}%</div>` : ''}
              </div>
            </div>
          </div>
        `;

        const stepsContainer = document.getElementById("steps");
        if (best.etapes && best.etapes.length > 0) {
          console.log(`📋 Affichage des ${best.etapes.length} étapes`);
          let etapesHTML = `<h3 style="color: #3498db; font-size: 14px; margin: 0 0 10px 0;">📋 ÉTAPES (${best.etapes.length})</h3>`;
          best.etapes.forEach((etape, index) => {
            const nomCourt = etape.engrenage.nom.split('/').pop().replace('.png', '');
            etapesHTML += `
              <div style="background: rgba(0,0,0,0.3); padding: 8px; margin: 3px 0; border-radius: 5px; border-left: 3px solid #3498db; font-size: 11px;">
                <span style="color: #95a5a6; font-weight: bold;">Étape ${index + 1}:</span>
                <span style="color: #ecf0f1;">Déplacer</span>
                <span style="color: #2ecc71; font-weight: bold;">${nomCourt}</span>
                <span style="color: #ecf0f1;">de</span>
                <span style="color: #e74c3c; font-weight: bold;">[${etape.deX + 1}, ${etape.deY + 1}]</span>
                <span style="color: #ecf0f1;">vers</span>
                <span style="color: #2ecc71; font-weight: bold;">[${etape.versX + 1}, ${etape.versY + 1}]</span>
              </div>
            `;
          });
          stepsContainer.innerHTML = etapesHTML;
          console.log("✅ Étapes affichées");
        }

        document.getElementById("solvetext").innerText = "Optimiser";
        openCogTab();

      } catch (error) {
        console.error("❌ Erreur:", error);
        document.getElementById("solvetext").innerText = "Optimiser";
        alert("Erreur lors de l'optimisation: " + error.message);
      }
    };
  </script>
</body>

</html>