<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="dark light" />

  <link rel="icon" type="image/x-icon" href="favicon.ico" />

  <link rel="stylesheet" href="style.css" />
  <script type="text/javascript" src="Optimiseur.js"></script>
  <script type="text/javascript" src="Resolveur.js"></script>
  <script type="text/javascript" src="InventaireEngrenages.js"></script>
  <script type="text/javascript" src="AfficheurPlateau.js"></script>
  <script type="text/javascript" src="AfficheurJoueur.js"></script>
  <script type="text/javascript" src="GestionPages.js"></script>


  <title>Jarvis Cog Optimisateur</title>

  <style>
    /* Styles pour la console de logs */
    #logConsole {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #1a1a2e;
      border-top: 3px solid #ff6b6b;
      max-height: 250px;
      overflow-y: auto;
      z-index: 9999;
      padding: 15px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      box-shadow: 0 -4px 6px rgba(0, 0, 0, 0.3);
    }

    #toggleLogs {
      position: fixed;
      bottom: 10px;
      right: 10px;
      background: #ff6b6b;
      color: white;
      border: none;
      padding: 10px 15px;
      cursor: pointer;
      border-radius: 5px;
      z-index: 10000;
      font-weight: bold;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    #toggleLogs:hover {
      background: #ee5a5a;
    }

    .log-line {
      margin: 3px 0;
      padding: 5px;
      border-left: 3px solid #555;
      padding-left: 10px;
    }

    .log-error {
      color: #e74c3c;
      background: #3d0a0a;
      border-left-color: #e74c3c;
    }

    .log-warn {
      color: #f39c12;
      border-left-color: #f39c12;
    }

    .log-success {
      color: #2ecc71;
      border-left-color: #2ecc71;
    }

    .log-info {
      color: #3498db;
      border-left-color: #3498db;
    }
  </style>
</head>

<body>
  <div class="menucontainer">
    <ul class="menu">
      <li id="loaderbtn" class="active">
        <div>
          <div>
            <div>Chargeur</div>
          </div>
        </div>
      </li>
      <li id="cogbtn">
        <div>
          <div>
            <div>Engrenages</div>
          </div>
        </div>
      </li>
    </ul>
    <div class="options">
      <button id="settingsbtn">
        <div></div>
        <div>
          Param√®tres
          <div class="checkbox"></div>
        </div>
        <div></div>
      </button>
      <button id="solve">
        <div></div>
        <div id="solvetext">Optimiser</div>
        <div></div>
      </button>
    </div>
    <div class="spacer"></div>
  </div>

  <div class="content">
    <!-- Popup de tutoriel -->
    <div id="tutorialPopup" style="
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(135deg, #1a2332 0%, #2d3e50 100%);
        padding: 40px;
        border-radius: 15px;
        border: 3px solid #3498db;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        z-index: 10000;
        max-width: 600px;
        text-align: center;
      ">
      <h2 style="color: #3498db; margin: 0 0 20px 0; font-size: 28px;">
        üéÆ Bienvenue sur Jarvis Cog Optimisateur !
      </h2>

      <div style="color: #ecf0f1; font-size: 16px; line-height: 1.8; text-align: left; margin-bottom: 30px;">
        <p style="margin: 15px 0;"><strong style="color: #2ecc71;">üìå √âtape 1 :</strong> Copiez les donn√©es sur <a
            href="https://idleontoolbox.com/data" target="_blank" style="color: #3498db;">IdleonToolbox.com/data</a></p>
        <p style="margin: 15px 0;"><strong style="color: #2ecc71;">üìå √âtape 2 :</strong> Collez-les dans la zone de
          texte ci-dessous</p>
        <p style="margin: 15px 0;"><strong style="color: #2ecc71;">üìå √âtape 3 :</strong> Cliquez sur "Charger" pour
          importer vos engrenages</p>
        <p style="margin: 15px 0;"><strong style="color: #2ecc71;">üìå √âtape 4 :</strong> Cliquez sur "Optimiser" pour
          obtenir la meilleure configuration</p>
      </div>

      <button onclick="closeTutorial()" style="
          background: #2ecc71;
          color: white;
          border: none;
          padding: 15px 40px;
          font-size: 18px;
          font-weight: bold;
          border-radius: 8px;
          cursor: pointer;
          box-shadow: 0 4px 10px rgba(46, 204, 113, 0.4);
        ">
        J'ai compris ! üöÄ
      </button>
    </div>

    <!-- Fond sombre derri√®re la popup -->
    <div id="tutorialOverlay" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 9999;
      "></div>

    <div id="loader">
      <div class="inputarea">
        <textarea type="textarea" id="input" rows="10" cols="100"></textarea>
        <div>
          <button id="load" style="max-width: 15ch;">Charger</button>
        </div>
      </div>
    </div>

    <div id="result">
      <div class="info">
        <div id="spare">---Placeholder---</div>
        <div id="sparepage"></div>
      </div>
      <div class="border" id="border"></div>

      <div id="settings" style="display: none;">
        <p>
          <label for="flaggyShop">Am√©liorations Flaggy (Boutique gemmes)</label><br />
          <input type="number" id="flaggyShop" value="0" style="width:6ch" disabled=true></input>
        </p>
        <p>
          <label for="buildRate">Poids vitesse de construction</label><br />
          <input type="number" id="buildRate" value="2" style="width:6ch"></input>
        </p>
        <p>
          <label for="expBonus">Poids bonus EXP</label><br />
          <input type="number" id="expBonus" value="50" style="width:6ch"></input>
        </p>
        <p>
          <label for="flaggy">Poids taux Flaggy</label><br />
          <input type="number" id="flaggy" value="5" style="width:6ch"></input>
        </p>
        <p>
          <label for="solveTime">Temps d'optimisation (ms)</label><br />
          <input type="number" id="solveTime" value="2500" style="width:10ch"></input>
        </p>
        <h4>Divers</h4>
        <hr />
        <p>
          <label for="showStats">Afficher les stats des engrenages ?</label>
          <input type="checkbox" id="showStats" />
        </p>
        <p>
          <label for="showSolved">Afficher directement la grille optimis√©e</label>
          <input type="checkbox" id="showSolved" />
        </p>
      </div>
    </div>
    <div id="currentBoard"></div>
    <div id="steps"></div>
  </div>

  <!-- Console de logs pour debug -->
  <div id="logConsole">
    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
      <span style="color: #ff6b6b; font-weight: bold;">üìã Console de Debug</span>
      <div>
        <button onclick="copyLogs()"
          style="background: #3498db; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 3px; margin-right: 5px;">üìã
          Copier</button>
        <button onclick="clearLogs()"
          style="background: #e74c3c; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 3px;">Effacer</button>
      </div>
    </div>
    <div id="logContent"></div>
  </div>
  </div>

  <!-- Bouton pour afficher/masquer les logs -->
  <button id="toggleLogs">üìã Logs</button>




  <script type="text/javascript">
    // ========================================
    // SYST√àME DE LOGS POUR DEBUG
    // ========================================

    const originalConsoleLog = console.log;
    const originalConsoleError = console.error;
    const originalConsoleWarn = console.warn;

    function addLog(message, type = 'info') {
      const logContent = document.getElementById('logContent');
      if (!logContent) return;

      const logLine = document.createElement('div');
      logLine.className = `log-line log-${type}`;

      const timestamp = new Date().toLocaleTimeString();

      switch (type) {
        case 'error':
          logLine.textContent = `‚ùå [${timestamp}] ${message}`;
          break;
        case 'warn':
          logLine.textContent = `‚ö†Ô∏è [${timestamp}] ${message}`;
          break;
        case 'success':
          logLine.textContent = `‚úÖ [${timestamp}] ${message}`;
          break;
        default:
          logLine.textContent = `‚ÑπÔ∏è [${timestamp}] ${message}`;
      }

      logContent.appendChild(logLine);
      logContent.scrollTop = logContent.scrollHeight;

      if (type === 'error') {
        originalConsoleError(message);
      } else if (type === 'warn') {
        originalConsoleWarn(message);
      } else {
        originalConsoleLog(message);
      }
    }

    console.log = function (...args) {
      addLog(args.join(' '), 'info');
    };

    console.error = function (...args) {
      addLog(args.join(' '), 'error');
    };

    console.warn = function (...args) {
      addLog(args.join(' '), 'warn');
    };

    window.addEventListener('error', (event) => {
      addLog(`ERREUR GLOBALE: ${event.message} (${event.filename}:${event.lineno})`, 'error');
    });

    document.getElementById('toggleLogs').addEventListener('click', () => {
      const logConsole = document.getElementById('logConsole');
      if (logConsole.style.display === 'none' || logConsole.style.display === '') {
        logConsole.style.display = 'block';
      } else {
        logConsole.style.display = 'none';
      }
    });

    function clearLogs() {
      document.getElementById('logContent').innerHTML = '';
      addLog('Logs effac√©s', 'info');
    }

    function copyLogs() {
      const logContent = document.getElementById('logContent');
      const texte = logContent.innerText;

      navigator.clipboard.writeText(texte).then(() => {
        addLog('‚úÖ Logs copi√©s dans le presse-papiers !', 'success');

        setTimeout(() => {
          const logs = logContent.querySelectorAll('.log-line');
          const dernierLog = logs[logs.length - 1];
          if (dernierLog && dernierLog.textContent.includes('Logs copi√©s')) {
            dernierLog.style.opacity = '0.5';
          }
        }, 2000);
      }).catch((err) => {
        addLog('‚ùå Erreur lors de la copie : ' + err, 'error');
      });
    }

    function closeTutorial() {
      document.getElementById("tutorialPopup").style.display = "none";
      document.getElementById("tutorialOverlay").style.display = "none";
    }

    addLog('üöÄ Interface charg√©e - Syst√®me de logs activ√©', 'success');

    document.getElementById("cogbtn").style.pointerEvents = "none";
    document.getElementById("cogbtn").style.opacity = "0.5";
    document.getElementById("settingsbtn").disabled = true;
    document.getElementById("settingsbtn").style.opacity = "0.5";
    document.getElementById("solve").disabled = true;
    document.getElementById("solve").style.opacity = "0.5";

    // ========================================
    // CODE PRINCIPAL
    // ========================================

    function createSwitchAnimation() {
      let fromDiv, timerID;

      fromDiv = document.createElement("div");
      document.body.appendChild(fromDiv);

      return function animateSwitch(fromElem, targetBoundingRect) {
        fromDiv.className = "";

        Object.values(fromElem.style)
          .filter((v) => !(v in ["height", "width", "position"]))
          .forEach((key) => {
            let value = fromElem.style[key];
            fromDiv.style[key] = value;
          });

        const bounds = fromElem.getBoundingClientRect();
        fromDiv.style.width = bounds.width + "px";
        fromDiv.style.height = bounds.height + "px";
        fromDiv.style.top = bounds.top + "px";
        fromDiv.style.left = bounds.left + "px";

        clearTimeout(timerID);
        timerID = setTimeout(() => {
          fromDiv.className = "switch";

          const bounds = targetBoundingRect;
          fromDiv.style.width = bounds.width + "px";
          fromDiv.style.height = bounds.height + "px";
          fromDiv.style.top = bounds.top + "px";
          fromDiv.style.left = bounds.left + "px";
        }, 10);
      }
    }

    const animateSwitchFrom = createSwitchAnimation();
    const animateSwitchTo = createSwitchAnimation();

    const player = new AfficheurJoueur();
    window.player = player;

    const ROWS = 8;
    const COLUMNS = 12;
    const OPTIMIZABLE = ["buildRate", "expBonus", "flaggy"];

    const getInput = (id) => Number.parseInt(document.getElementById(id).value);
    const getFlaggyShop = getInput.bind(null, "flaggyShop");

    const createElem = function createElem(tagName, style = undefined) {
      const elem = document.createElement(tagName);
      if (style) {
        elem.style = style;
      }
      return elem;
    }

    window.g = {
      cogs: {},
      board: [],
      best: null
    };
    window.f = {};

    window.boardRenderer = new AfficheurPlateau(ROWS, COLUMNS, "board");
    window.spareRenderer = new AfficheurPlateau(40, 3, "spare", 5);
    window.solver = new Resolveur();
    window.cogInventory = new InventaireEngrenages();

    window.sparePage = new GestionPages("sparepage", window.spareRenderer._pageCount, 1);
    window.sparePage.addEventListener("change", (ev) => {
      window.spareRenderer.showPage(ev.page);
    });

    const boardElem = document.getElementById("currentBoard");
    boardElem.innerHTML = "";
    boardElem.appendChild(window.boardRenderer.createHTMLElement());

    const stepContainer = createElem("div");
    stepContainer.id = "stepspage";
    boardElem.appendChild(stepContainer);
    const stepsPage = new GestionPages("stepspage", 0, 0, "√âtape");
    stepsPage.addEventListener("change", stepsChangeHandler);

    window.addEventListener("keyup", (ev) => {
      if (ev.key == "ArrowLeft") {
        stepsPage.prev(ev);
      } else if (ev.key == "ArrowRight") {
        stepsPage.next(ev);
      }
    }, true);

    const spareElem = document.getElementById("spare");
    const spareParent = spareElem.parentNode;
    spareParent.insertBefore(window.spareRenderer.createHTMLElement(), spareElem);
    spareParent.removeChild(spareElem);

    const settingsBtn = document.getElementById("settingsbtn");
    const slider = settingsBtn.childNodes[3].childNodes[1];
    const settingsPage = document.getElementById("settings");
    const borderElem = document.getElementById("border");
    settingsBtn.addEventListener("click", () => {
      const active = slider.classList.contains("active");
      if (active) {
        slider.classList.remove("active");
        settingsPage.style.display = "none";
      } else {
        openCogTab();

        slider.classList.add("active");
        settingsPage.style.display = "";
        settingsPage.style.left = borderElem.offsetLeft + "px";
        settingsPage.style.height = borderElem.offsetHeight + "px";
      }
    })

    f.verifyBoardIntegrity = (board) => {
      for (let y = 0; y < board.length; y++) {
        for (let x = 0; x < board[y].length; x++) {
          if (board[y][x].blocked) continue;
          const tempPos = board[y][x].position();
          if (tempPos.x !== x || tempPos.y !== y) {
            debugger;
          }
        }
      }
    }

    f.printBoard = (board, cord1 = {}, cord2 = {}) => {
      for (let i = 0; i < board.length; i++) {
        const row = createElem("tr");

        for (let j = 0; j < board[i].length; j++) {
          window.boardRenderer.set(i, j, board[i][j]);
        }
      }

      console.log("Grille mise √† jour");
    }

    function yield() {
      return new Promise(r => setTimeout(r, 1));
    }

    f.printMove = (stepNumber, board, cog1, cog2, pos1, pos2, showStats = false) => {
      const toAdd = createElem("p");

      let text = `√âchanger ${pos1.location} \
        [${pos1.x + 1}|${pos1.y + 1}]`;
      if (showStats) {
        text += ` (${cog1.buildRate || 0}:${cog1.expBonus || 0}:${cog1.flaggy || 0})`;
      }
      text += ` <span style="background-image: url('${cog1.icon.path}')"></span> avec ${pos2.location} [${pos2.x + 1}|${pos2.y + 1}]`;
      if (showStats) {
        text += ` (${cog2.buildRate || 0}:${cog2.expBonus || 0}:${cog2.flaggy || 0})`;
      }
      text += ` <span style="background-image: url('${cog2.icon.path}')"></span>`;

      toAdd.innerHTML = text;

      toAdd.onclick = () => {
        stepsPage.goto(stepNumber);
      }
      document.getElementById("steps").appendChild(toAdd);
    }

    f.getOptimalSteps = (board, cogs) => {
      const steps = [];

      const cogsToMove = Object.values(cogs)
        .map(c => { return new Engrenage(c) })
        .filter((c) => c.key !== c.initialKey);

      const interimCogs = {};
      for (const cog of cogsToMove) {
        interimCogs[cog.initialKey] = cog;
      }

      let tuple;
      while (tuple = Object.entries(interimCogs)[0]) {
        const [key, cog] = tuple;
        const targetCog = interimCogs[cog.key] || { icon: "Blank", key, position: cog.position.bind(cog) };
        if (targetCog === cog) {
          delete interimCogs[key];
          continue;
        }
        interimCogs[key] = targetCog;
        steps.push({
          board,
          cog,
          targetCog,
          keyFrom: Number.parseInt(key),
          keyTo: Number.parseInt(cog.key)
        });
        delete interimCogs[cog.key];
      }

      return steps;
    }

    f.printOptimalSteps = (steps) => {
      document.getElementById("steps").innerHTML = "";
      const showStats = document.getElementById("showStats").checked;

      for (let i = 0; i < steps.length; i++) {
        const step = steps[i];
        f.printMove(
          i,
          step.board,
          step.cog,
          step.targetCog,
          step.cog.position(step.keyFrom),
          step.targetCog.position(step.keyTo),
          showStats);
      }
    }

    function mmoifyNumber(num, addSign = true) {
      let str = num;

      if (Math.abs(num) >= 1000000) {
        str = (Math.ceil(num / 10000) / 100) + "M";
      } else if (Math.abs(num) >= 1000) {
        str = (Math.ceil(num / 10) / 100) + "K";
      }

      if (addSign && num >= 0) {
        str = "+" + str;
      }

      return str.toString();
    }
    function load(save) {
      try {
        console.log("üîÑ D√©marrage du chargement...");

        console.log("üì¶ Chargement des donn√©es de sauvegarde...");
        cogInventory.load(save);
        console.log("‚úÖ Inventaire charg√©");

        document.getElementById("flaggyShop").value = cogInventory.ameliorationsBoutiqueFlaggy;
        console.log("üíé Am√©liorations Flaggy (boutique):", cogInventory.ameliorationsBoutiqueFlaggy);
        console.log("‚úÖ Flaggy shop mis √† jour");

        // Charger les engrenages spare
        for (let i = 108; i < 200; i++) {
          const engrenage = cogInventory.engrenages[i];

          if (!engrenage) continue;
          const index = (i - 108);
          const row = Math.floor(index / 3);
          const col = index % 3;
          window.spareRenderer.set(row, col, engrenage);
        }
        console.log("‚úÖ Engrenages spare affich√©s");

        // Recalculer le nombre de pages
        window.spareRenderer._pageCount = Math.ceil(Object.keys(cogInventory.engrenages).filter(k => parseInt(k) >= 108).length / 3);
        window.sparePage.nombrePages = window.spareRenderer._pageCount;  // ‚úÖ UTILISE nombrePages
        window.sparePage.indexPage = 0;  // ‚úÖ AJOUTE indexPage
        window.sparePage.goto(0);
        console.log("üìÑ Nombre de pages spare recalcul√©:", window.spareRenderer._pageCount);
        console.log("‚úÖ Page spare initialis√©e");


        const initScore = cogInventory.score;

        f.printBoard(cogInventory.board);
        console.log("‚úÖ Grille affich√©e");

        document.getElementById("solve").disabled = "";
        console.log("‚úÖ Bouton optimiser activ√©");

        const stepsContainer = document.getElementById("steps");
        console.log("‚úÖ stepsContainer r√©cup√©r√©");

        stepsContainer.remove();
        console.log("‚úÖ stepsContainer retir√©");

        const currentBoard = document.getElementById("currentBoard");
        currentBoard.parentElement.insertBefore(stepsContainer, currentBoard.nextSibling);
        console.log("‚úÖ stepsContainer replac√©");

        stepsContainer.style.display = "block";
        stepsContainer.style.width = "100%";
        stepsContainer.style.clear = "both";
        stepsContainer.style.marginTop = "20px";
        console.log("‚úÖ Styles appliqu√©s");

        stepsContainer.innerHTML = `
            <div style="padding: 25px; background: linear-gradient(135deg, #16213e 0%, #1a2740 100%); border-radius: 10px; margin-top: 20px; border: 2px solid #3498db; box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);">
              <h2 style="color: #3498db; margin: 0 0 25px 0; text-align: center; font-size: 24px;">
                üìä STATS ACTUELLES
              </h2>
              <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div style="background: #0f1923; padding: 25px; border-radius: 8px; border: 2px solid #3498db; text-align: center;">
                  <div style="color: #95a5a6; font-size: 13px; margin-bottom: 10px;">üèóÔ∏è Vitesse de construction</div>
                  <div style="color: #3498db; font-weight: bold; font-size: 28px;">
                    ${mmoifyNumber(initScore.buildRate, false)}/HR
                  </div>
                </div>
                <div style="background: #0f1923; padding: 25px; border-radius: 8px; border: 2px solid #9b59b6; text-align: center;">
                  <div style="color: #95a5a6; font-size: 13px; margin-bottom: 10px;">‚≠ê Bonus XP Joueur</div>
                  <div style="color: #9b59b6; font-weight: bold; font-size: 28px;">
                    ${mmoifyNumber(initScore.expBonus, false)}%
                  </div>
                </div>
                <div style="background: #0f1923; padding: 25px; border-radius: 8px; border: 2px solid #e67e22; text-align: center;">
                  <div style="color: #95a5a6; font-size: 13px; margin-bottom: 10px;">üö© Taux de Flaggy</div>
                  <div style="color: #e67e22; font-weight: bold; font-size: 28px;">
                    ${mmoifyNumber(initScore.flaggy, false)}/HR
                  </div>
                </div>
              </div>
              <div style="text-align: center; padding: 15px; background: rgba(52, 152, 219, 0.1); border-radius: 5px;">
                <p style="color: #95a5a6; margin: 0; font-size: 13px;">
                  üí° <strong>Astuce :</strong> Cliquez sur "Optimiser" pour am√©liorer votre configuration !
                </p>
              </div>
            </div>
          `;
        console.log("‚úÖ HTML des stats ins√©r√©");

        for (let oneOption of [...OPTIMIZABLE, "solveTime"]) {
          const val = localStorage.getItem(oneOption);
          if (val) {
            document.getElementById(oneOption).value = val;
          }
        }
        console.log("‚úÖ Options charg√©es");

        openCogTab();
        console.log("‚úÖ Onglet Engrenages ouvert");

        document.getElementById("cogbtn").style.pointerEvents = "auto";
        document.getElementById("cogbtn").style.opacity = "1";
        document.getElementById("settingsbtn").disabled = false;
        document.getElementById("settingsbtn").style.opacity = "1";
        document.getElementById("solve").disabled = false;
        document.getElementById("solve").style.opacity = "1";
        console.log("‚úÖ Tous les boutons activ√©s");

        console.log("üéâ CHARGEMENT TERMIN√â AVEC SUCC√àS !");

      } catch (error) {
        console.error("‚ùå ERREUR LORS DU CHARGEMENT:", error);
        console.error("‚ùå Stack trace:", error.stack);
      }
    }

    function fetchAndLoadConfig(username) {
      console.log("Tentative de r√©cup√©ration", username);
      if (username.length > 0) {
        const headers = {
          "Content-Type": "text/json",
          method: "GET"
        };
        fetch(`https://cdn.idleonefficiency.com/profiles/${username.toLowerCase()}.json`, headers)
          .then((response) => {
            return response.json();
          }).then((json) => {
            load(json);
          }).catch((reason) => {
            console.log(reason);
          });
      }
    }

    document.getElementById("load").addEventListener("click", () => {
      const input = document.getElementById("input").value;
      try {
        const save = JSON.parse(input);
        load(save);
      } catch (e) {
        if (e instanceof SyntaxError) {
          fetchAndLoadConfig(input);
        }
      }
    });

    let optimalSteps = undefined;

    function stepsChangeHandler(ev) {
      const clone = cogInventory.clone();
      for (let i = 0; i < ev.page; i++) {
        const step = optimalSteps[i];
        clone.move(step.keyFrom, step.keyTo);
      }

      const currentStep = optimalSteps[ev.page];
      const pos1 = currentStep.cog.position(currentStep.keyFrom);
      const pos2 = currentStep.targetCog.position(currentStep.keyTo);

      f.printBoard(clone.board);
      window.boardRenderer.move(pos1, pos2);

      if (pos1.location == "spare" || pos2.location == "spare") {
        let pos = pos1;
        if (pos2.location == "spare") {
          pos = pos2;
        }
        const page = window.spareRenderer.getPage(pos);
        if (page != -1) {
          sparePage.goto(page);
        }
      }

      window.spareRenderer.move(pos1, pos2);

      const renderer = {
        [window.boardRenderer._type]: window.boardRenderer,
        [window.spareRenderer._type]: window.spareRenderer
      };

      const pos1Slot = renderer[pos1.location].get(pos1.y, pos1.x);
      const pos2Slot = renderer[pos2.location].get(pos2.y, pos2.x);

      if (pos1Slot.item && pos1Slot.item.icon !== "Blank" && pos1Slot.elem.childNodes.length === 1) {
        const from = pos1Slot.elem.childNodes[0];
        animateSwitchFrom(from, pos2Slot.elem.getBoundingClientRect());
      }
      if (pos2Slot.item && pos2Slot.item.icon !== "Blank" && pos2Slot.elem.childNodes.length === 1) {
        const to = pos2Slot.elem.childNodes[0];
        animateSwitchTo(to, pos1Slot.elem.getBoundingClientRect());
      }
    }
    document.getElementById("solve").onclick = async () => {
      const solveTime = getInput("solveTime") || 2500;
      localStorage.setItem("solveTime", solveTime);
      document.getElementById("solvetext").innerText = "Optimisation...";
      document.getElementById("steps").innerHTML = "";
      let lastYield = Date.now();
      await yield();

      console.log("D√©marrage");

      let start = cogInventory.clone();

      const [buildRate, expBonus, flaggy] = [getInput("buildRate"), getInput("expBonus"), getInput("flaggy")];
      localStorage.setItem("buildRate", buildRate);
      localStorage.setItem("expBonus", expBonus);
      localStorage.setItem("flaggy", flaggy);
      solver.setWeights(getInput("buildRate"), getInput("expBonus"), getInput("flaggy"));
      const best = await solver.solve(cogInventory, solveTime);

      const buildRateGain = best.score.buildRate - start.score.buildRate;
      const expBonusGain = best.score.expBonus - start.score.expBonus;
      const flaggyGain = best.score.flaggy - start.score.flaggy;

      const buildRatePercent = start.score.buildRate > 0 ? ((buildRateGain / start.score.buildRate) * 100).toFixed(1) : 0;
      const expBonusPercent = start.score.expBonus > 0 ? ((expBonusGain / start.score.expBonus) * 100).toFixed(1) : 0;
      const flaggyPercent = start.score.flaggy > 0 ? ((flaggyGain / start.score.flaggy) * 100).toFixed(1) : 0;

      console.log("Affichage de la grille optimis√©e...");
      f.printBoard(best.board);

      const stepsContainer = document.getElementById("steps");
      const parentDiv = stepsContainer.parentElement;

      stepsContainer.remove();

      const currentBoard = document.getElementById("currentBoard");
      currentBoard.parentElement.insertBefore(stepsContainer, currentBoard.nextSibling);

      stepsContainer.style.display = "block";
      stepsContainer.style.width = "100%";
      stepsContainer.style.clear = "both";
      stepsContainer.style.marginTop = "20px";

      stepsContainer.innerHTML = `
          <div style="padding: 25px; background: linear-gradient(135deg, #16213e 0%, #1a2740 100%); border-radius: 10px; margin-top: 20px; border: 2px solid #2ecc71; box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3);">
            <h2 style="color: #2ecc71; margin: 0 0 25px 0; text-align: center; font-size: 24px;">
              ‚úÖ OPTIMISATION R√âUSSIE !
            </h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 20px;">
              <div style="background: #0f1923; padding: 25px; border-radius: 8px; border: 2px solid #e74c3c;">
                <h3 style="color: #e74c3c; margin: 0 0 20px 0; font-size: 20px; text-align: center;">üìä AVANT OPTIMISATION</h3>
                <div style="border-top: 2px solid #2c3e50; margin: 10px 0 20px 0;"></div>
                <div style="margin: 15px 0;">
                  <div style="color: #95a5a6; font-size: 13px; margin-bottom: 5px;">üèóÔ∏è Vitesse de construction</div>
                  <div style="color: #ecf0f1; font-weight: bold; font-size: 20px;">
                    ${mmoifyNumber(start.score.buildRate, false)}/HR
                  </div>
                </div>
                <div style="margin: 15px 0;">
                  <div style="color: #95a5a6; font-size: 13px; margin-bottom: 5px;">‚≠ê Bonus XP Joueur</div>
                  <div style="color: #ecf0f1; font-weight: bold; font-size: 20px;">
                    ${mmoifyNumber(start.score.expBonus, false)}%
                  </div>
                </div>
                <div style="margin: 15px 0;">
                  <div style="color: #95a5a6; font-size: 13px; margin-bottom: 5px;">üö© Taux de Flaggy</div>
                  <div style="color: #ecf0f1; font-weight: bold; font-size: 20px;">
                    ${mmoifyNumber(start.score.flaggy, false)}/HR
                  </div>
                </div>
                <div style="border-top: 2px solid #2c3e50; margin: 20px 0 10px 0;"></div>
                <div style="text-align: center; color: #95a5a6; font-weight: bold; font-size: 13px;">
                  üí∞ Score initial : ${start.score.buildRate.toFixed(0)}
                </div>
              </div>
              <div style="background: #0f1923; padding: 25px; border-radius: 8px; border: 2px solid #2ecc71;">
                <h3 style="color: #2ecc71; margin: 0 0 20px 0; font-size: 20px; text-align: center;">üìà APR√àS OPTIMISATION</h3>
                <div style="border-top: 2px solid #2c3e50; margin: 10px 0 20px 0;"></div>
                <div style="margin: 15px 0;">
                  <div style="color: #95a5a6; font-size: 13px; margin-bottom: 5px;">üèóÔ∏è Vitesse de construction</div>
                  <div style="color: #2ecc71; font-weight: bold; font-size: 20px;">
                    ${mmoifyNumber(best.score.buildRate, false)}/HR
                  </div>
                  ${buildRatePercent > 0 ? `<div style="color: #3498db; font-size: 15px; margin-top: 5px;">‚ñ≤ +${mmoifyNumber(buildRateGain)}/HR (+${buildRatePercent}%)</div>` : ''}
                </div>
                <div style="margin: 15px 0;">
                  <div style="color: #95a5a6; font-size: 13px; margin-bottom: 5px;">‚≠ê Bonus XP Joueur</div>
                  <div style="color: ${expBonusGain >= 0 ? '#2ecc71' : '#ecf0f1'}; font-weight: bold; font-size: 20px;">
                    ${mmoifyNumber(best.score.expBonus, false)}%
                  </div>
                  ${expBonusPercent > 0 ? `<div style="color: #3498db; font-size: 15px; margin-top: 5px;">‚ñ≤ +${mmoifyNumber(expBonusGain)}% (+${expBonusPercent}%)</div>` : expBonusGain === 0 ? '<div style="color: #95a5a6; font-size: 14px; margin-top: 5px;">= Inchang√©</div>' : ''}
                </div>
                <div style="margin: 15px 0;">
                  <div style="color: #95a5a6; font-size: 13px; margin-bottom: 5px;">üö© Taux de Flaggy</div>
                  <div style="color: #2ecc71; font-weight: bold; font-size: 20px;">
                    ${mmoifyNumber(best.score.flaggy, false)}/HR
                  </div>
                  ${flaggyPercent > 0 ? `<div style="color: #3498db; font-size: 15px; margin-top: 5px;">‚ñ≤ +${mmoifyNumber(flaggyGain)}/HR (+${flaggyPercent}%)</div>` : ''}
                </div>
                <div style="border-top: 2px solid #2c3e50; margin: 20px 0 10px 0;"></div>
                <div style="text-align: center; color: #2ecc71; font-weight: bold; font-size: 13px;">
                  üí∞ Score final : ${best.score.buildRate.toFixed(0)}
                </div>
              </div>
            </div>
            <div style="background: rgba(52, 152, 219, 0.1); padding: 20px; border-radius: 8px; border-left: 4px solid #3498db;">
              <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; color: #ecf0f1; font-size: 14px;">
                <div style="text-align: center;">
                  <div style="color: #3498db; font-weight: bold; font-size: 16px;">üß¨ 250</div>
                  <div style="color: #95a5a6; font-size: 12px;">G√©n√©rations</div>
                </div>
                <div style="text-align: center;">
                  <div style="color: #9b59b6; font-weight: bold; font-size: 16px;">üì¶ ${Object.keys(best.cogs).length}</div>
                  <div style="color: #95a5a6; font-size: 12px;">Engrenages</div>
                </div>
                <div style="text-align: center;">
                  <div style="color: #e67e22; font-weight: bold; font-size: 16px;">‚ö° < 1s</div>
                  <div style="color: #95a5a6; font-size: 12px;">Temps d'ex√©cution</div>
                </div>
              </div>
            </div>
            <div style="text-align: center; padding: 15px; margin-top: 15px; background: rgba(52, 152, 219, 0.05); border-radius: 5px;">
              <p style="color: #95a5a6; margin: 0; font-size: 13px;">
                üí° <strong>Astuce :</strong> Les √©tapes d√©taill√©es seront ajout√©es dans la prochaine version
              </p>
            </div>
          </div>
        `;

      document.getElementById("solvetext").innerText = "Optimiser";
      openCogTab();
    };

    function openCogTab() {
      document.getElementById("loader").style.display = "none";
      document.getElementById("result").style.display = "inherit";

      document.getElementById("loaderbtn").className = "";
      document.getElementById("cogbtn").className = "active";
    }

    function openLoaderTab() {
      document.getElementById("loader").style.display = "inherit";
      document.getElementById("result").style.display = "none";

      document.getElementById("loaderbtn").className = "active";
      document.getElementById("cogbtn").className = "";
    }

    document.getElementById("loaderbtn").addEventListener("click", () => {
      openLoaderTab();
    });
    document.getElementById("cogbtn").addEventListener("click", () => {
      openCogTab();
    });
  </script>
</body>

</html>